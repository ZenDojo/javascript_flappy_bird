<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flappy Bird Javascript</title>
    <link rel="stylesheet" href="./style.css">
    <link rel="icon" href="favicon.png">
</head>

<body>
    <div id="game">
        <div id="block"></div>
        <div id="hole"></div>
        <div id="character"></div>
        <div id="score">Score 0</div>
        <div id="gameoverscreen" style="display: none;">
            <h1 class="title">Game Over</h1>
            <h3 class="score">Score 0</h3>
            <button>Play Again ?</button>
            <div class="backdrop"></div>
        </div>
        <div id="star" style="display: none;"></div>
    </div>
    <script>
        const getRandomNumber = (min, max) => {
            return Math.floor(Math.random() * (max - min) + min)
        }

        const getCssProp = (element, cssProperty) => {
            return window
                .getComputedStyle(element)
                .getPropertyValue(cssProperty)
        }

        const detectColision = (el1, el2, extra) => {
            const rect1 = el1.getBoundingClientRect()
            const rect2 = el2.getBoundingClientRect()

            extra = extra || {
                y1: 0,
                y2: 0
            }

            return (
                rect1.x < rect2.x + rect2.width &&
                rect1.x + rect1.width > rect2.x &&
                rect1.y < rect2.y + rect2.height + extra.y1 &&
                rect1.y + rect1.height > rect2.y + extra.y2
            )
        }

        let game, block, hole, character, score, gameoverscreen, star, gameStopped, isJumping, scoreTotal

        function getElements() {
            game = document.querySelector('#game')
            block = document.querySelector('#block')
            hole = document.querySelector('#hole')
            character = document.querySelector('#character')
            score = document.querySelector('#score')
            gameoverscreen = document.querySelector('#gameoverscreen')
            star = document.querySelector('#star')
        }

        function setInitialValues() {
            gameStopped = false
            isJumping = false
            scoreTotal = 0
        }

        function setEventListeners() {
            window.addEventListener('resize', () => {
                if (gameStopped) return
                resetAllAnimations()
            })
            gameoverscreen.querySelector('button').addEventListener('click', () => {
                location.reload()
            })
            document.body.parentElement.addEventListener('click', () => {
                if (gameStopped) return
                characterJump()
            })
            document.onkeypress = e => {
                // e = e || window.event
                if (e.keyCode === 32) {
                    if (gameStopped) return
                    characterJump()
                }
            }
        }

        function gameOver() {
            (new Audio('./sounds/gameover.wav')).play()
            gameStopped = true
            showGameOverScreen()
            stopBlockAnimation()
            console.log('Game Over');
        }

        function showGameOverScreen() {
            gameoverscreen.style.display = ''
        }

        function stopBlockAnimation() {
            const blockLeft = block.getBoundingClientRect().x
            block.style.animation = ''
            hole.style.animation = ''

            block.style.left = `${blockLeft}px`
            hole.style.left = `${blockLeft}px`
        }

        function startBgAnimation() {
            game.style.animation = 'backgroundAnimation 5s infinite linear'
        }

        function characterJump() {
            isJumping = true
            let jumpCount = 0
            const jumpInterval = setInterval(() => {
                changeGameState({ diff: -4, direction: 'up' })
                if (jumpCount > 20) {
                    (new Audio('./sounds/fly.wav')).play()
                    clearInterval(jumpInterval)
                    isJumping = false
                    jumpCount = 0
                }
                jumpCount++
            }, 20);
        }

        function changeGameState({ diff, direction }) {
            handleCharacterAnimation(direction)
            handleCharacterCollisions()
            handleCharacterPosition(diff)
        }

        function handleCharacterAnimation(direction) {
            if (direction === 'down') {
                character.classList.remove('go-up')
                character.classList.add('go-down')
            } else if (direction === 'up') {
                character.classList.add('go-up')
                character.classList.remove('go-down')
            }
        }

        function changeScoreUi() {
            score.innerText = `Score ${scoreTotal}`
            gameoverscreen.querySelector('.score').innerText = score.innerText
        }

        function handleCharacterCollisions() {
            const colisionBlock = detectColision(character, block)
            const colisionHole = detectColision(character, hole, { y1: -46, y2: 47 })
            if (colisionBlock && !colisionHole) {
                return gameOver()
            } else if (colisionHole) {
                scoreTotal++
                if (scoreTotal % 100 == 0) {
                    (new Audio('./sounds/hole')).play()
                }
                changeScoreUi()
            }
        }

        function handleCharacterPosition(diff) {
            const characterTop = parseInt(getCssProp(character, 'top'))
            const changeTop = characterTop + diff
            if (changeTop < 0) {
                return
            }
            if (changeTop > window.innerHeight) {
                return gameOver()
            }
            character.style.top = `${changeTop}px`
        }

        function initRandomHoles() {
            hole.addEventListener('animationiteration', _ => {
                const fromHeight = 57 * window.innerHeight / 100
                const toHeight = 97 * window.innerHeight / 100
                const randomTop = getRandomNumber(fromHeight, toHeight)
                hole.style.top = `-${randomTop}px`
            })
        }

        function beginGravity() {
            setInterval(() => {
                if (isJumping || gameStopped) return
                changeGameState({ diff: 5, direction: 'down' })
            }, 20);
        }

        function resetAllAnimations() {
            const seconds = 3
            const blockAnumationCss = `blockAnimation ${seconds}s infinite linear`
            block.style.animation = blockAnumationCss
            hole.style.animation = blockAnumationCss
        }

        function gameInit() {
            getElements()
            initRandomHoles()
            beginGravity()
            resetAllAnimations()
            setInitialValues()
            setEventListeners()
            startBgAnimation()
            handleCharacterCollisions()
        }

        gameInit()
    </script>
</body>

</html>